<?phpnamespace NITSAN\NsT3dev\Error;use Doctrine\DBAL\Driver\Exception;use Throwable;use TYPO3\CMS\Core\Authentication\BackendUserAuthentication;use TYPO3\CMS\Core\Database\ConnectionPool;use TYPO3\CMS\Core\Error\ErrorHandlerInterface;use TYPO3\CMS\Core\SysLog\Action as SystemLogGenericAction;use TYPO3\CMS\Core\SysLog\Error as SystemLogErrorClassification;use TYPO3\CMS\Core\SysLog\Type as SystemLogType;use TYPO3\CMS\Core\Utility\GeneralUtility;use Psr\Log\LoggerAwareInterface;use Psr\Log\LoggerAwareTrait;use Psr\Log\LoggerInterface;use TYPO3\CMS\Core\Error\ExceptionHandlerInterface;class PostExceptionsOnProduct extends \TYPO3\CMS\Core\Error\DebugExceptionHandler{    use LoggerAwareTrait;    public function echoExceptionWeb(Throwable $exception)    {        $this->postExceptionsOnProduct($exception);    }    public function postExceptionsOnProduct($exception)    {        $connection = GeneralUtility::makeInstance(ConnectionPool::class)            ->getConnectionForTable('sys_log');        if (!$connection->isConnected()) {            return;        }        $userId = 0;        $workspace = 0;        $data = [];        $logMessage = 'Something went wrong, check your configuration!';        $backendUser = $this->getBackendUser();        if ($backendUser instanceof BackendUserAuthentication) {            if (isset($backendUser->user['uid'])) {                $userId = $backendUser->user['uid'];            }            $workspace = $backendUser->workspace;            if ($backUserId = $backendUser->getOriginalUserIdWhenInSwitchUserMode()) {                $data['originalUser'] = $backUserId;            }        }        $connection->insert(            'sys_log',            [                'userid' => $userId,                'type' => SystemLogType::ERROR,                'channel' => SystemLogType::toChannel(SystemLogType::ERROR),                'action' => SystemLogGenericAction::UNDEFINED,                'error' => SystemLogErrorClassification::SYSTEM_ERROR,                'level' => SystemLogType::toLevel(SystemLogType::ERROR),                'details_nr' => 0,                'details' => str_replace('%', '%%', $logMessage),                'log_data' => empty($data) ? '' : serialize($data),                'IP' => (string)GeneralUtility::getIndpEnv('REMOTE_ADDR'),                'tstamp' => $GLOBALS['EXEC_TIME'],                'workspace' => $workspace,            ]        );        $content = $this->getErrorContent($logMessage);        $css = $this->getStylesheet();        echo <<<HTML            <!DOCTYPE html>            <html>                <head>                    <meta charset="UTF-8" />                    <title>TYPO3 Exception</title>                    <meta name="robots" content="noindex,nofollow" />                    <style>$css</style>                </head>                <body>                    $content                </body>            </html>        HTML;    }    /**     * Generates the HTML for the error output.     *     * @param $logMessage     * @return string     */    protected function getErrorContent($logMessage): string    {        $content = '';        $documentationLink = '';        $content = $logMessage;        $exceptionInfo = '';        if (!empty($logMessage)) {            $exceptionInfo = <<<INFO            <div class="container">                <div class="callout">                    <h4 class="callout-title">Get help in the TYPO3 Documentation</h4>                    <div class="callout-body">                        <p>                            If you need help solving this exception, you can have a look at the TYPO3 Documentation.                            There you can find solutions provided by the TYPO3 community.                            Once you have found a solution to the problem, help others by contributing to the                            documentation page.                        </p>                        <p>                            <a href="$documentationLink" target="_blank" rel="noreferrer">Find a solution for this exception in the TYPO3 Documentation.</a>                        </p>                    </div>                </div>            </div>INFO;        }        $typo3Logo = $this->getTypo3LogoAsSvg();        return <<<HTML            <div class="exception-page">                <div class="exception-summary">                    <div class="container">                        <div class="exception-message-wrapper">                            <div class="exception-illustration hidden-xs-down">$typo3Logo</div>                            <h1 class="exception-message break-long-words">Whoops, looks like something went wrong.</h1>                        </div>                    </div>                </div>                $exceptionInfo                <div class="container">                    $content                </div>            </div>HTML;    }    /**     * Generates the stylesheet needed to display the error page.     *     * @return string     */    protected function getStylesheet(): string    {        return <<<STYLESHEET            html {                -webkit-text-size-adjust: 100%;                -ms-text-size-adjust: 100%;                -ms-overflow-style: scrollbar;                -webkit-tap-highlight-color: transparent;            }            body {                margin: 0;            }            .exception-page {                background-color: #eaeaea;                color: #212121;                font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";                font-weight: 400;                height: 100vh;                line-height: 1.5;                overflow-x: hidden;                overflow-y: scroll;                text-align: left;                top: 0;            }            .panel-collapse .exception-page {                height: 100%;            }            .exception-page a {                color: #ff8700;                text-decoration: underline;            }            .exception-page a:hover {                text-decoration: none;            }            .exception-page abbr[title] {                border-bottom: none;                cursor: help;                text-decoration: none;            }            .exception-page code,            .exception-page kbd,            .exception-page pre,            .exception-page samp {                font-family: SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;                font-size: 1em;            }            .exception-page pre {                background-color: #ffffff;                overflow-x: auto;                border: 1px solid rgba(0,0,0,0.125);            }            .exception-page pre span {                display: block;                line-height: 1.3em;            }            .exception-page pre span:before {                display: inline-block;                content: attr(data-line);                border-right: 1px solid #b9b9b9;                margin-right: 0.5em;                padding-right: 0.5em;                background-color: #f4f4f4;                width: 4em;                text-align: right;                color: #515151;            }            .exception-page pre span.highlight {                background-color: #cce5ff;            }            .exception-page .break-long-words {                -ms-word-break: break-all;                word-break: break-all;                word-break: break-word;                -webkit-hyphens: auto;                -moz-hyphens: auto;                hyphens: auto;            }            .exception-page .callout {                padding: 1.5rem;                background-color: #fff;                margin-bottom: 2em;                box-shadow: 0 2px 1px rgba(0,0,0,.15);                border-left: 3px solid #8c8c8c;            }            .exception-page .callout-title {                margin: 0;            }            .exception-page .callout-body p:last-child {                margin-bottom: 0;            }            .exception-page .container {                max-width: 1140px;                margin: 0 auto;                padding: 0 30px;            }            .panel-collapse .exception-page .container {                width: 100%;            }            .exception-page .exception-illustration {                width: 3em;                height: 3em;                float: left;                margin-right: 1rem;            }            .exception-page .exception-illustration svg {                width: 100%;            }            .exception-page .exception-illustration svg path {                fill: #ff8700;            }            .exception-page .exception-summary {                background: #000000;                color: #fff;                padding: 1.5rem 0;                margin-bottom: 2rem;            }            .exception-page .exception-summary h1 {                margin: 0;            }            .exception-page .text-muted {                opacity: 0.5;            }            .exception-page .trace {                background-color: #fff;                margin-bottom: 2rem;                box-shadow: 0 2px 1px rgba(0,0,0,.15);            }            .exception-page .trace-arguments {                color: #8c8c8c;            }            .exception-page .trace-body {            }            .exception-page .trace-call {                margin-bottom: 1rem;            }            .exception-page .trace-class {                margin: 0;            }            .exception-page .trace-file pre {                margin-top: 1.5rem;                margin-bottom: 0;            }            .exception-page .trace-head {                color: #721c24;                background-color: #f8d7da;                padding: 1.5rem;            }            .exception-page .trace-file-path {                word-break: break-all;            }            .exception-page .trace-message {                margin-bottom: 0;            }            .exception-page .trace-step {                padding: 1.5rem;                border-bottom: 1px solid #b9b9b9;            }            .exception-page .trace-step > *:first-child {                margin-top: 0;            }            .exception-page .trace-step > *:last-child {                margin-bottom: 0;            }            .exception-page .trace-step:nth-child(even)            {                background-color: #fafafa;            }            .exception-page .trace-step:last-child {                border-bottom: none;            }STYLESHEET;    }}?>