<?phpnamespace NITSAN\NsT3dev\Error;use Doctrine\DBAL\Driver\Exception;use Throwable;use TYPO3\CMS\Core\Authentication\BackendUserAuthentication;use TYPO3\CMS\Core\Database\ConnectionPool;use TYPO3\CMS\Core\Error\ErrorHandlerInterface;use TYPO3\CMS\Core\SysLog\Action as SystemLogGenericAction;use TYPO3\CMS\Core\SysLog\Error as SystemLogErrorClassification;use TYPO3\CMS\Core\SysLog\Type as SystemLogType;use TYPO3\CMS\Core\Utility\GeneralUtility;use Psr\Log\LoggerAwareInterface;use Psr\Log\LoggerAwareTrait;use Psr\Log\LoggerInterface;use TYPO3\CMS\Core\Error\ExceptionHandlerInterface;class PostExceptionsOnProduct extends \TYPO3\CMS\Core\Error\DebugExceptionHandler{    use LoggerAwareTrait;    public function echoExceptionWeb(Throwable $exception)    {        $this->postExceptionsOnProduct($exception);    }    public function postExceptionsOnProduct($exception)    {        $connection = GeneralUtility::makeInstance(ConnectionPool::class)            ->getConnectionForTable('sys_log');        if (!$connection->isConnected()) {            return;        }        $userId = 0;        $workspace = 0;        $data = [];        $logMessage = 'Something went wrong, check your configuration!';        $backendUser = $this->getBackendUser();        if ($backendUser instanceof BackendUserAuthentication) {            if (isset($backendUser->user['uid'])) {                $userId = $backendUser->user['uid'];            }            $workspace = $backendUser->workspace;            if ($backUserId = $backendUser->getOriginalUserIdWhenInSwitchUserMode()) {                $data['originalUser'] = $backUserId;            }        }        $connection->insert(            'sys_log',            [                'userid' => $userId,                'type' => SystemLogType::ERROR,                'channel' => SystemLogType::toChannel(SystemLogType::ERROR),                'action' => SystemLogGenericAction::UNDEFINED,                'error' => SystemLogErrorClassification::SYSTEM_ERROR,                'level' => SystemLogType::toLevel(SystemLogType::ERROR),                'details_nr' => 0,                'details' => str_replace('%', '%%', $logMessage),                'log_data' => empty($data) ? '' : serialize($data),                'IP' => (string)GeneralUtility::getIndpEnv('REMOTE_ADDR'),                'tstamp' => $GLOBALS['EXEC_TIME'],                'workspace' => $workspace,            ]        );        $content = $this->getErrorContent($logMessage);        echo <<<HTML            <!DOCTYPE html>            <html>                <head>                    <meta charset="utf-8">                    <link rel="stylesheet" type="text/css" defer="" href="https://t3-dev.ddev.site/typo3conf/ext/ns_basetheme/Resources/Public/css/cookieconsent.min.css"><link rel="icon" href="/typo3conf/ext/ns_basetheme/Resources/Public/Icons/favicon.ico" type="image/vnd.microsoft.icon">                    <title>Product</title>                    <meta name="generator" content="TYPO3 CMS">                    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, user-scalable=no">                    <meta name="twitter:card" content="summary">                    <link rel="stylesheet" href="/typo3temp/assets/css/575885ca93502ee14d7020b0a21fede6.css?1703481853" media="all">                    <link rel="stylesheet" href="/typo3conf/ext/ns_basetheme/Resources/Public/vendor/bootstrap/css/bootstrap.min.css?1695641175" media="all">                    <link rel="stylesheet" href="/typo3conf/ext/ns_basetheme/Resources/Public/css/ns_basetheme.css?1695641175" media="all">                    <script src="https://t3-dev.ddev.site/typo3conf/ext/ns_basetheme/Resources/Public/js/cookieconsent.min.js" defer=""></script><script async="" src="https://www.google-analytics.com/analytics.js"></script><script data-ignore="1" data-cookieconsent="statistics" type="text/plain"></script>            <!-- Google Analytics GAv3 -->                    <script type="text/javascript" data-ignore="1" defer="" src="https://t3-dev.ddev.site/typo3conf/ext/ns_basetheme/Resources/Public/js/cookie.min.js?v=9.5.2"></script>                    <!-- End Cookie Consent plugin -->                    <style></style>                    <link rel="canonical" href="https://t3-dev.ddev.site/product">                    <style></style>                </head>                <body>                    <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark fixed-top">                      <div class="container">                        <a class="navbar-brand" href="/">                            composer req nitsan/ns-basetheme                        </a>                        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">                          <span class="navbar-toggler-icon"></span>                        </button>                        <div class="collapse navbar-collapse" id="navbarResponsive">&nbsp; &nbsp;                            <a href="#" class="btn btn-primary">Sign Up</a>                        </div>                      </div>                    </nav>                    $content                </body>            </html>        HTML;    }    /**     * Generates the HTML for the error output.     *     * @param $logMessage     * @return string     */    protected function getErrorContent($logMessage): string    {        $content = $logMessage;        $exceptionInfo = '';        return <<<HTML            <div class="exception-page">                <div class="exception-summary">                    <div class="container">                        <div class="exception-message-wrapper">                            <h1 class="exception-message break-long-words">Whoops, looks like something went wrong.</h1>                        </div>                    </div>                </div>                $exceptionInfo                <div class="frame frame-default frame-type-text frame-layout-0 frame-space-before-extra-large frame-space-after-extra-large">                    <div class="container">                        <h3 style="color: red">$content</h3>                    </div>                </div>            </div>            <footer class="py-5 bg-dark">                <div class="container">                    <div class="row">                        <div class="col-sm-6 m-0 text-left text-white">            </div>                        <div class="col-sm-6 m-0 text-right text-white">@&nbsp;2023&nbsp;Copyright</div>                    </div>                </div>            </footer>HTML;    }}?>